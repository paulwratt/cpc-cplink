ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 1.
Hexadecimal [16-Bits]



                              1 	;; Amstrad CPC Firmware routines
                              2 	;;
                              3 	;; (c) Revaldinho 2019
                              4 	;;
                              5 	;; All use standard SDCC stack based calling convention unless marked otherwise.
                              6 	;;
                              7 	;; Parameters are pushed onto the stack from right to left, and finally the
                              8 	;; return address is pushed.
                              9 	;;
                             10 	;;     +2N-> 16n Parameter N
                             11 	;;     +4 -> 16b Parameter 2
                             12 	;;     +2 -> 16b Parameter 1
                             13 	;;  SP +0 -> [Return Address]
                             14 	;;
                             15 	;; SDCC uses IX, IY for local register pointers, so need to preserve these
                             16 	;; in firmware calls. Registers which are used in these wrappers are usually
                             17 	;; spotted and preserved before and after the call, but any registers corrupted
                             18 	;; inside firmware calls will need to be preserved explictly in the wrappers.
                             19 
                             20 	;; ====================================
                             21 	;; Graphics Calls
                             22 	;; ====================================
                             23 
                             24         ;; -------------------------------------------------------
                             25 	;; gra_set_pen - Set graphics pen ink.  (__z88dk_fastcall)
                             26         ;; -------------------------------------------------------
                             27 	;;
                             28 	;; Entry:
                             29 	;; - l = pen
                             30 	;; Exit
                             31 	;; - af corrupt
                             32 	;; - all other registers preserved
   0000                      33 _gra_set_pen::
   0000 7D            [ 4]   34         ld      a, l
   0001 CD DE BB      [17]   35         call    #0xbbde
   0004 C9            [10]   36         ret
                             37         ;; -------------------------------------------------------
                             38         ;; gra_line_abs - draw a line to an absolute position
                             39         ;; -------------------------------------------------------
                             40 	;;
                             41 	;; Entry:
                             42 	;; - Param 1 = X
                             43 	;; - Param 2 = Y
                             44 	;;
                             45 	;; Exit:
                             46 	;; - af corrupt
                             47 	;; - de, hl used in wrapper
                             48 	;; - all other registers preserved
   0005                      49 _gra_line_abs::
   0005 DD E5         [15]   50 	push 	ix
   0007 DD 21 04 00   [14]   51         ld      ix,#4
   000B DD 39         [15]   52         add     ix,sp
                             53 
   000D DD 5E 00      [19]   54 	ld 	e, 0(ix)
   0010 DD 56 01      [19]   55 	ld 	d, 1(ix)
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 2.
Hexadecimal [16-Bits]



   0013 DD 6E 02      [19]   56 	ld 	l, 2(ix)
   0016 DD 66 03      [19]   57 	ld 	h, 3(ix)
   0019 C5            [11]   58 	push	bc
   001A CD F6 BB      [17]   59         call    #0xbbf6
   001D C1            [10]   60 	pop	bc
   001E DD E1         [14]   61 	pop	ix
   0020 C9            [10]   62         ret
                             63         ;; ---------------------------------------------------
                             64         ;; gra_move_abs - Move graphics cursor to an absolute position
                             65         ;; ---------------------------------------------------
                             66 	;;
                             67 	;; Entry:
                             68 	;; - Param 1 = X
                             69 	;; - Param 2 = Y
                             70 	;;
                             71 	;; Exit:
                             72 	;; - af corrupt
                             73 	;; - de, hl used in wrapper
                             74 	;; - all other registers preserved
   0021                      75 _gra_move_abs::
   0021 DD E5         [15]   76 	push 	ix
   0023 DD 21 04 00   [14]   77         ld      ix,#4
   0027 DD 39         [15]   78         add     ix,sp
                             79 
   0029 DD 5E 00      [19]   80 	ld 	e, 0(ix)
   002C DD 56 01      [19]   81 	ld 	d, 1(ix)
   002F DD 6E 02      [19]   82 	ld 	l, 2(ix)
   0032 DD 66 03      [19]   83 	ld 	h, 3(ix)
   0035 C5            [11]   84 	push	bc
   0036 CD C0 BB      [17]   85         call    #0xbbc0
   0039 C1            [10]   86 	pop	bc
   003A DD E1         [14]   87 	pop	ix
   003C C9            [10]   88         ret
                             89 
                             90         ;; ---------------------------------------------------
                             91         ;; gra_plot_abs - Plot a point at an absolute position
                             92         ;; ---------------------------------------------------
                             93 	;;
                             94 	;; Entry:
                             95 	;; - Param 1 = X
                             96 	;; - Param 2 = Y
                             97 	;;
                             98 	;; Exit:
                             99 	;; - af corrupt
                            100 	;; - de, hl used in wrapper
                            101 	;; - all other registers preserved
   003D                     102 _gra_plot_abs::
   003D DD E5         [15]  103 	push 	ix
   003F DD 21 04 00   [14]  104         ld      ix,#4
   0043 DD 39         [15]  105         add     ix,sp
                            106 
   0045 DD 5E 00      [19]  107 	ld 	e, 0(ix)
   0048 DD 56 01      [19]  108 	ld 	d, 1(ix)
   004B DD 6E 02      [19]  109 	ld 	l, 2(ix)
   004E DD 66 03      [19]  110 	ld 	h, 3(ix)
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 3.
Hexadecimal [16-Bits]



   0051 C5            [11]  111 	push	bc
   0052 CD EA BB      [17]  112         call    #0xbbea
   0055 C1            [10]  113 	pop	bc
   0056 DD E1         [14]  114 	pop	ix
   0058 C9            [10]  115         ret
                            116 
                            117         ;; ---------------------------------------------------
                            118 	;; gra_set_origin  - set the origin of the user coordinates
                            119         ;; ---------------------------------------------------
                            120 	;;
                            121 	;; Entry:
                            122 	;; - Param 1 = X
                            123 	;; - Param 2 = Y
                            124 	;;
                            125 	;; Exit:
                            126 	;; - af corrupt
                            127 	;; - de, hl used in wrapper
                            128 	;; - all other registers preserved
   0059                     129 _gra_set_origin::
   0059 DD E5         [15]  130 	push 	ix
   005B DD 21 04 00   [14]  131         ld      ix,#4
   005F DD 39         [15]  132         add     ix,sp
                            133 
   0061 DD 5E 00      [19]  134 	ld 	e, 0(ix)
   0064 DD 56 01      [19]  135 	ld 	d, 1(ix)
   0067 DD 6E 02      [19]  136 	ld 	l, 2(ix)
   006A DD 66 03      [19]  137 	ld 	h, 3(ix)
   006D C5            [11]  138 	push	bc
   006E CD C9 BB      [17]  139         call    #0xbbc9
   0071 C1            [10]  140 	pop	bc
   0072 DD E1         [14]  141 	pop	ix
   0074 C9            [10]  142         ret
                            143 
                            144 	;; ====================================
                            145 	;; Kernel Block Calls
                            146 	;; ====================================
                            147 
                            148         ;; ---------------------------------------------------
                            149 	;; kl_time_please - Ask elapsed time
                            150         ;; ---------------------------------------------------
                            151 	;;
                            152 	;; Entry
                            153 	;; - no parameters
                            154 	;; Exit
                            155 	;; - <de,hl> - time in 1/300th sec (32bit long int)
                            156 	;; - all other registers preserved
   0075                     157 _kl_time_please::
   0075 CD 0D BD      [17]  158         call    #0xbd0d
   0078 C9            [10]  159         ret
                            160 
                            161         ;; ---------------------------------------------------
                            162 	;; kl_time_set - set elapsed time (usu. to zero) (__z88dk_fastcall)
                            163         ;; ---------------------------------------------------
                            164 	;;
                            165 	;; Entry
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 4.
Hexadecimal [16-Bits]



                            166 	;; <dehl> - time in 1/300th sec (32b long int)
                            167 	;; Exit
                            168 	;; - af corrupt
                            169 	;; - all registers preserved
   0079                     170 _kl_time_set::
   0079 CD 10 BD      [17]  171         call    #0xbd10
   007C C9            [10]  172         ret
                            173 
                            174 	;; ====================================
                            175 	;; Keyboard Manager Calls
                            176 	;; ====================================
                            177 
                            178         ;; ---------------------------------------------------
                            179 	;; km_wait_char - Wait for a key press and return ASCII value (__z88dk_fastcall)
                            180         ;; ---------------------------------------------------
                            181 	;;
                            182 	;;
                            183 	;; Entry:
                            184 	;; - none
                            185 	;; Exit:
                            186 	;; - carry - True
                            187 	;; - l     - character
                            188 	;; - af corrupt
                            189 	;; - all other registers preserved
   007D                     190 _km_wait_char::
   007D CD 06 BB      [17]  191 	call 	#0xbb06
   0080 6F            [ 4]  192 	ld 	l,a
   0081 C9            [10]  193 	ret
                            194 
                            195 	;; ====================================
                            196 	;; Screen Pack Calls
                            197 	;; ====================================
                            198 
                            199         ;; ---------------------------------------------------
                            200         ;; scr_set_mode - set screen to new mode (__z88dk_fastcall)
                            201         ;; ---------------------------------------------------
                            202 	;;
                            203 	;; Entry:
                            204 	;; - l - new mode
                            205 	;; Exit:
                            206 	;; - af corrupt
                            207 	;; - all other registers preserved
   0082                     208 _scr_set_mode::
   0082 7D            [ 4]  209         ld      a,l
   0083 E5            [11]  210 	push	hl
   0084 C5            [11]  211 	push	bc
   0085 D5            [11]  212 	push	de
   0086 CD 0E BC      [17]  213         call    #0xbc0e
   0089 D1            [10]  214 	pop	de
   008A C1            [10]  215 	pop	bc
   008B E1            [10]  216 	pop	hl
   008C C9            [10]  217         ret
